name: üì± Cordova APK Build

on:
  workflow_dispatch:
    inputs:
      clean_build:
        description: 'Clean build'
        required: false
        default: 'true'
        type: boolean

jobs:
  build-cordova:
    runs-on: ubuntu-latest
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
      
    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: üìã Install dependencies
      run: npm install --legacy-peer-deps
      
    - name: üèóÔ∏è Build PWA
      run: npm run build
      
    - name: üì± Install Cordova
      run: |
        npm install -g cordova
        cordova --version
        
    - name: ‚öôÔ∏è Create Cordova project
      run: |
        # Create Cordova project
        cordova create cordova-app com.novado.app "Novado"
        cd cordova-app
        
        # Copy PWA files
        rm -rf www/*
        cp -r ../dist/* www/
        
        # Add Android platform
        cordova platform add android
        
        # Update config.xml
        cat > config.xml << 'EOF'
<?xml version='1.0' encoding='utf-8'?>
<widget id="com.novado.app" version="1.0.0" xmlns="http://www.w3.org/ns/widgets">
    <name>Novado</name>
    <description>–ë–µ–∑–ª—ñ—á –æ–≥–æ–ª–æ—à–µ–Ω—å —á–µ–∫–∞—é—Ç—å –Ω–∞ —Ç–µ–±–µ</description>
    <author email="support@novado.com.ua" href="https://novado.com.ua">Novado Team</author>
    <content src="index.html" />
    <allow-intent href="http://*/*" />
    <allow-intent href="https://*/*" />
    <platform name="android">
        <allow-intent href="market:*" />
        <preference name="AndroidLaunchMode" value="singleTop" />
        <preference name="AndroidXEnabled" value="true" />
        <preference name="GradlePluginKotlinEnabled" value="true" />
        <preference name="GradlePluginKotlinCodeStyle" value="official" />
    </platform>
    <preference name="DisallowOverscroll" value="true" />
    <preference name="android-minSdkVersion" value="22" />
    <preference name="android-targetSdkVersion" value="34" />
</widget>
EOF
        
    - name: ‚òï Setup Java for Cordova
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ü§ñ Setup Android SDK for Cordova
      uses: android-actions/setup-android@v3
      
    - name: üì± Accept SDK licenses
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
      
    - name: üîß Install Android requirements
      run: |
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0"
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "platforms;android-34"
        
    - name: üèóÔ∏è Build Cordova APK
      run: |
        cd cordova-app
        
        echo "üöÄ Building Cordova APK..."
        cordova build android --debug --verbose
        
        echo "üìÅ Checking build results:"
        find platforms/android -name "*.apk" -type f
        
        if [ -f "platforms/android/app/build/outputs/apk/debug/app-debug.apk" ]; then
          echo "‚úÖ Cordova APK built successfully!"
          cp platforms/android/app/build/outputs/apk/debug/app-debug.apk ../novado-cordova.apk
          ls -la ../novado-cordova.apk
        else
          echo "‚ùå Cordova APK not found!"
          exit 1
        fi
        
    - name: üìã Get version
      id: version
      run: echo "VERSION=$(date +'%Y.%m.%d-%H%M')-cordova" >> $GITHUB_OUTPUT
      
    - name: üöÄ Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.VERSION }}
        name: üì± Novado v${{ steps.version.outputs.VERSION }} (Cordova)
        body: |
          üì± **Novado APK (Cordova Build)**
          
          üìÖ –í–µ—Ä—Å—ñ—è: ${{ steps.version.outputs.VERSION }}
          üèóÔ∏è –ú–µ—Ç–æ–¥: Apache Cordova
          üì± –ù–∞–∑–≤–∞: **Novado**
          
          ### üì• –í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è:
          1. –ó–∞–≤–∞–Ω—Ç–∞–∂—Ç–µ APK –Ω–∏–∂—á–µ
          2. –£–≤—ñ–º–∫–Ω—ñ—Ç—å "–ù–µ–≤—ñ–¥–æ–º—ñ –¥–∂–µ—Ä–µ–ª–∞"
          3. –í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å APK —Ñ–∞–π–ª
          4. –í—ñ–¥–∫—Ä–∏–π—Ç–µ **Novado**
          
          ### ‚ú® –§—É–Ω–∫—Ü—ñ—ó:
          - üé¨ Splash screen –∑ –∞–Ω—ñ–º–∞—Ü—ñ—î—é
          - üì± –Ü–∫–æ–Ω–∫–∞ –∑ –±—É–∫–≤–æ—é N
          - üá∫üá¶ "–ë–µ–∑–ª—ñ—á –æ–≥–æ–ª–æ—à–µ–Ω—å —á–µ–∫–∞—é—Ç—å –Ω–∞ —Ç–µ–±–µ"
          - üîÑ –ê–≤—Ç–æ–æ–Ω–æ–≤–ª–µ–Ω–Ω—è
          - üåê –ü–æ–≤–Ω–∞ —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å
          
        files: novado-cordova.apk
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}