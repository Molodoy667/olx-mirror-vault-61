import{v as R,h as M,r as o,s as u,t as v,w as T,u as D,j as e,B as q}from"./index-KbJkRX07.js";import{H as F,S as $,b as B}from"./Footer-CG381HwE.js";import{I as H}from"./input-BfmWFPkP.js";import{A as C,b as k}from"./avatar-CGybcn-y.js";import{A as L}from"./arrow-left-8vQ30E0Z.js";import{U as P}from"./user-Dt39FPRe.js";import{S as z}from"./send-D3STE-AU.js";import{f as A,u as E}from"./uk-Drv84rxe.js";import"./useAdmin-wN6CKAL8.js";import"./Combination-CN-dILO0.js";import"./badge-DpjjU75J.js";import"./index-D5jjwgwZ.js";import"./select-CxSQralT.js";import"./index-ohYBQjSJ.js";import"./globe-BvyP_gKp.js";import"./star-B840Te7u.js";import"./eye-jg7wg44x.js";import"./heart-BstkNJZ-.js";import"./search-B1u6Ento.js";import"./plus-D5zmitre.js";function G(){const d=R(),{user:c}=M();o.useEffect(()=>{if(!c)return;const r=u.channel("messages_channel").on("postgres_changes",{event:"INSERT",schema:"public",table:"messages",filter:`receiver_id=eq.${c.id}`},f=>{d.invalidateQueries({queryKey:["messages"]}),d.invalidateQueries({queryKey:["conversations"]}),v({title:"Нове повідомлення",description:"Ви отримали нове повідомлення"})}).subscribe(),m=u.channel("message_updates_channel").on("postgres_changes",{event:"UPDATE",schema:"public",table:"messages"},()=>{d.invalidateQueries({queryKey:["messages"]}),d.invalidateQueries({queryKey:["conversations"]})}).subscribe(),_=u.channel("notifications_channel").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${c.id}`},f=>{d.invalidateQueries({queryKey:["notifications"]});const p=f.new;v({title:p.title||"Нове сповіщення",description:p.message})}).subscribe();return()=>{r.unsubscribe(),m.unsubscribe(),_.unsubscribe()}},[c,d])}function me(){var S;const{userId:d}=T(),c=D(),{user:r}=M(),[m,_]=o.useState([]),[f,p]=o.useState([]),[t,g]=o.useState(d||null),[x,j]=o.useState(""),[b,y]=o.useState(!1);G(),o.useEffect(()=>{if(!r){c("/auth");return}N(),t&&(w(t),Q(t))},[t,r,c]);const N=async()=>{if(r)try{const{data:s,error:i}=await u.from("messages").select(`
          *,
          sender_profiles:profiles!messages_sender_id_fkey(id, full_name, username, avatar_url),
          receiver_profiles:profiles!messages_receiver_id_fkey(id, full_name, username, avatar_url),
          listings(id, title)
        `).or(`sender_id.eq.${r.id},receiver_id.eq.${r.id}`).order("created_at",{ascending:!1});if(i)throw i;const l=new Map;s==null||s.forEach(a=>{const h=a.sender_id===r.id?a.receiver_id:a.sender_id,n=a.sender_id===r.id?a.receiver_profiles:a.sender_profiles;if(!l.has(h))l.set(h,{user_id:h,user_name:(n==null?void 0:n.full_name)||(n==null?void 0:n.username)||"Користувач",avatar_url:n==null?void 0:n.avatar_url,last_message:a.content,last_message_time:a.created_at,unread_count:!a.is_read&&a.receiver_id===r.id?1:0});else{const K=l.get(h);!a.is_read&&a.receiver_id===r.id&&K.unread_count++}}),_(Array.from(l.values()))}catch(s){console.error("Error loading chats:",s)}},w=async s=>{if(r)try{const{data:i,error:l}=await u.from("messages").select("*, listings(id, title)").or(`and(sender_id.eq.${r.id},receiver_id.eq.${s}),and(sender_id.eq.${s},receiver_id.eq.${r.id})`).order("created_at",{ascending:!0});if(l)throw l;p(i||[])}catch(i){console.error("Error loading messages:",i)}},Q=async s=>{r&&await u.from("messages").update({is_read:!0}).eq("sender_id",s).eq("receiver_id",r.id)},I=async s=>{if(s.preventDefault(),!(!x.trim()||!t||!r)){y(!0);try{const{error:i}=await u.from("messages").insert({sender_id:r.id,receiver_id:t,content:x.trim()});if(i)throw i;j(""),w(t),N()}catch{v({title:"Помилка",description:"Не вдалося відправити повідомлення",variant:"destructive"})}finally{y(!1)}}};return r?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(F,{}),e.jsx("div",{className:"container mx-auto px-4 py-6",children:e.jsxs("div",{className:"bg-card rounded-lg shadow-lg h-[600px] flex",children:[e.jsxs("div",{className:"w-1/3 border-r",children:[e.jsx("div",{className:"p-4 border-b",children:e.jsx("h2",{className:"text-lg font-semibold",children:"Повідомлення"})}),e.jsx($,{className:"h-[530px]",children:m.length>0?m.map(s=>{var i;return e.jsx("div",{onClick:()=>g(s.user_id),className:`p-4 border-b cursor-pointer hover:bg-muted/50 ${t===s.user_id?"bg-muted":""}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(C,{children:e.jsx(k,{children:(i=s.user_name[0])==null?void 0:i.toUpperCase()})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"font-medium truncate",children:s.user_name}),s.unread_count>0&&e.jsx("span",{className:"bg-primary text-primary-foreground text-xs rounded-full px-2 py-1",children:s.unread_count})]}),e.jsx("p",{className:"text-sm text-muted-foreground truncate",children:s.last_message}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:A(new Date(s.last_message_time),{addSuffix:!0,locale:E})})]})]})},s.user_id)}):e.jsx("div",{className:"p-8 text-center text-muted-foreground",children:"У вас поки немає повідомлень"})})]}),e.jsx("div",{className:"flex-1 flex flex-col",children:t?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center gap-3",children:[e.jsx(q,{variant:"ghost",size:"icon",onClick:()=>g(null),className:"md:hidden",children:e.jsx(L,{className:"w-5 h-5"})}),e.jsx(C,{children:e.jsx(k,{children:e.jsx(P,{className:"w-5 h-5"})})}),e.jsx("div",{children:e.jsx("p",{className:"font-medium",children:((S=m.find(s=>s.user_id===t))==null?void 0:S.user_name)||"Користувач"})})]}),e.jsx($,{className:"flex-1 p-4",children:e.jsx("div",{className:"space-y-4",children:f.map(s=>e.jsxs("div",{children:[s.listings&&e.jsx("div",{className:"flex justify-center mb-4",children:e.jsxs("div",{onClick:()=>c(`/listing/${s.listings.id}`),className:"bg-muted/50 px-4 py-2 rounded-lg text-sm text-muted-foreground cursor-pointer hover:bg-muted",children:["Оголошення: ",s.listings.title]})}),e.jsx("div",{className:`flex ${s.sender_id===r.id?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[70%] rounded-lg p-3 ${s.sender_id===r.id?"bg-primary text-primary-foreground":"bg-muted"}`,children:[e.jsx("p",{className:"break-words",children:s.content}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:A(new Date(s.created_at),{addSuffix:!0,locale:E})})]})})]},s.id))})}),e.jsx("form",{onSubmit:I,className:"p-4 border-t",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(H,{value:x,onChange:s=>j(s.target.value),placeholder:"Напишіть повідомлення...",disabled:b}),e.jsx(q,{type:"submit",disabled:b||!x.trim(),children:e.jsx(z,{className:"w-5 h-5"})})]})})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-muted-foreground",children:"Виберіть чат для початку спілкування"})})]})}),e.jsx(B,{})]}):null}export{me as default};
