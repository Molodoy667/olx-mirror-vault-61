import{h as v,s as x,j as e,k as f,r as p,v as $,B as A}from"./index-KbJkRX07.js";import{S as M,H as F,b as k}from"./Footer-CG381HwE.js";import{u as h}from"./useQuery-DYBXd3SC.js";import{A as w,b as _,a as D}from"./avatar-CGybcn-y.js";import{a as j}from"./Combination-CN-dILO0.js";import{U as q}from"./user-Dt39FPRe.js";import{f as g,u as N}from"./uk-Drv84rxe.js";import{u as E}from"./useMutation-BJki3aSv.js";import{I as K}from"./input-BfmWFPkP.js";import{S as I}from"./send-D3STE-AU.js";import"./useAdmin-wN6CKAL8.js";import"./badge-DpjjU75J.js";import"./index-D5jjwgwZ.js";import"./select-CxSQralT.js";import"./index-ohYBQjSJ.js";import"./globe-BvyP_gKp.js";import"./star-B840Te7u.js";import"./eye-jg7wg44x.js";import"./heart-BstkNJZ-.js";import"./search-B1u6Ento.js";import"./plus-D5zmitre.js";const Q=()=>{const{user:a}=v();return h({queryKey:["conversations",a==null?void 0:a.id],queryFn:async()=>{if(!a)return[];const{data:t,error:c}=await x.from("conversations").select("*").or(`participant1_id.eq.${a.id},participant2_id.eq.${a.id}`).order("last_message_at",{ascending:!1});if(c)throw c;return t||[]},enabled:!!a})};function L({onSelectConversation:a}){const{data:t,isLoading:c}=Q(),{user:r}=v();return c?e.jsx("div",{className:"space-y-4",children:[...Array(5)].map((i,d)=>e.jsx("div",{className:"h-20 bg-muted rounded-lg animate-pulse"},d))}):!t||t.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx(j,{className:"w-12 h-12 text-muted-foreground mx-auto mb-4"}),e.jsx("p",{className:"text-muted-foreground",children:"Немає активних розмов"})]}):e.jsx("div",{className:"space-y-2",children:t.map(i=>{const o=(r==null?void 0:r.id)===i.participant1_id?i.participant2_id:i.participant1_id;return e.jsx(f,{className:"p-4 hover:bg-accent cursor-pointer transition-colors",onClick:()=>a(i.id,o),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(w,{className:"h-12 w-12",children:e.jsx(_,{children:e.jsx(q,{className:"h-6 w-6"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsxs("h3",{className:"font-semibold text-sm truncate",children:["Користувач ",o.slice(0,8)]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:g(new Date(i.last_message_at),{addSuffix:!0,locale:N})})]}),e.jsxs("p",{className:"text-sm text-muted-foreground truncate",children:["Останнє повідомлення: ",g(new Date(i.last_message_at),{addSuffix:!0,locale:N})]})]})]})},i.id)})})}function R({conversationId:a,otherUserId:t,listingId:c}){const{user:r}=v(),[i,d]=p.useState(""),o=p.useRef(null),y=$(),{data:m,isLoading:C}=h({queryKey:["messages",a,t],queryFn:async()=>{if(!r)return[];const{data:s,error:n}=await x.from("messages").select("*").or(`and(sender_id.eq.${r.id},receiver_id.eq.${t}),and(sender_id.eq.${t},receiver_id.eq.${r.id})`).order("created_at",{ascending:!0});if(n)throw n;return s},enabled:!!r&&!!t}),{data:l}=h({queryKey:["profile",t],queryFn:async()=>{const{data:s,error:n}=await x.from("profiles").select("full_name, avatar_url").eq("id",t).single();if(n)throw n;return s},enabled:!!t}),u=E({mutationFn:async s=>{if(!r)throw new Error("Not authenticated");const{data:n,error:b}=await x.from("messages").insert({sender_id:r.id,receiver_id:t,content:s,listing_id:c}).select().single();if(b)throw b;return n},onSuccess:()=>{d(""),y.invalidateQueries({queryKey:["messages"]}),y.invalidateQueries({queryKey:["conversations"]})}}),S=s=>{s.preventDefault(),!(!i.trim()||u.isPending)&&u.mutate(i.trim())};return p.useEffect(()=>{var s;(s=o.current)==null||s.scrollIntoView({behavior:"smooth"})},[m]),C?e.jsx("div",{className:"h-96 flex items-center justify-center",children:e.jsx("div",{className:"animate-pulse text-muted-foreground",children:"Завантаження повідомлень..."})}):e.jsxs(f,{className:"h-96 flex flex-col",children:[e.jsxs("div",{className:"p-4 border-b flex items-center gap-3",children:[e.jsxs(w,{className:"h-10 w-10",children:[e.jsx(D,{src:l==null?void 0:l.avatar_url}),e.jsx(_,{children:e.jsx(q,{className:"h-5 w-5"})})]}),e.jsx("div",{children:e.jsx("h3",{className:"font-semibold",children:(l==null?void 0:l.full_name)||"Користувач"})})]}),e.jsx(M,{className:"flex-1 p-4",children:e.jsxs("div",{className:"space-y-4",children:[m==null?void 0:m.map(s=>{const n=s.sender_id===(r==null?void 0:r.id);return e.jsx("div",{className:`flex ${n?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xs px-3 py-2 rounded-lg ${n?"bg-primary text-primary-foreground":"bg-muted"}`,children:[e.jsx("p",{className:"text-sm",children:s.content}),e.jsx("p",{className:"text-xs opacity-70 mt-1",children:g(new Date(s.created_at),{addSuffix:!0,locale:N})})]})},s.id)}),e.jsx("div",{ref:o})]})}),e.jsx("form",{onSubmit:S,className:"p-4 border-t",children:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(K,{value:i,onChange:s=>d(s.target.value),placeholder:"Введіть повідомлення...",disabled:u.isPending}),e.jsx(A,{type:"submit",disabled:!i.trim()||u.isPending,size:"icon",children:e.jsx(I,{className:"h-4 w-4"})})]})})]})}function ce(){const[a,t]=p.useState(null),c=(r,i)=>{t({id:r,otherUserId:i})};return e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(F,{}),e.jsx("div",{className:"container mx-auto px-4 py-8",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsx("div",{className:"lg:col-span-1",children:e.jsxs(f,{className:"p-4",children:[e.jsxs("h2",{className:"text-xl font-semibold mb-4 flex items-center gap-2",children:[e.jsx(j,{className:"w-5 h-5"}),"Повідомлення"]}),e.jsx(L,{onSelectConversation:c})]})}),e.jsx("div",{className:"lg:col-span-2",children:a?e.jsx(R,{conversationId:a.id,otherUserId:a.otherUserId,listingId:a.listingId}):e.jsx(f,{className:"h-96 flex items-center justify-center",children:e.jsxs("div",{className:"text-center text-muted-foreground",children:[e.jsx(j,{className:"w-12 h-12 mx-auto mb-4"}),e.jsx("p",{children:"Оберіть розмову для початку спілкування"})]})})})]})}),e.jsx(k,{})]})}export{ce as default};
