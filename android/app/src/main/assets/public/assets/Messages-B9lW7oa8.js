import{u as J,r as l,s as p,t as y,j as e,k as m,p as x,B as N}from"./index-KbJkRX07.js";import{u as K}from"./useAdmin-wN6CKAL8.js";import{A as Q,a as X}from"./AdminHeader-BFn_Zmrn.js";import{I as Y}from"./input-BfmWFPkP.js";import{T as Z,a as ee,b as A,c as d,d as se,e as c}from"./table--IrP7ivg.js";import{B}from"./badge-DpjjU75J.js";import{S as ae,d as te,e as ie,f as re,g as M}from"./select-CxSQralT.js";import{D as le,b as ne,c as de,d as ce}from"./dialog-C3rICmIe.js";import{A as v,b as w}from"./avatar-CGybcn-y.js";import{a as oe,P as me}from"./Combination-CN-dILO0.js";import{E}from"./eye-jg7wg44x.js";import{C as xe}from"./clock-DUppK43j.js";import{S as he}from"./search-B1u6Ento.js";import{U as b}from"./user-Dt39FPRe.js";import{T as I}from"./trash-2-CCvey3Fk.js";import"./index-CAsdkEwS.js";import"./users-CUWo_zW8.js";import"./dollar-sign--DFDUvgJ.js";import"./settings-DWrH-Tg4.js";import"./index-D5jjwgwZ.js";function Ee(){const S=J(),{isAdmin:_,loading:C}=K(),[h,H]=l.useState([]),[j,R]=l.useState(""),[u,U]=l.useState("all"),[z,F]=l.useState(!0),[i,P]=l.useState(null),[$,D]=l.useState(!1);l.useEffect(()=>{!C&&!_&&S("/")},[_,C,S]),l.useEffect(()=>{T()},[]);const T=async()=>{try{const{data:s,error:t}=await p.from("messages").select("*").order("created_at",{ascending:!1});if(t)throw t;const n=[...new Set([...s.map(a=>a.sender_id),...s.map(a=>a.receiver_id)])].filter(Boolean),r=s.map(a=>a.listing_id).filter(Boolean),[f,O]=await Promise.all([n.length>0?p.from("profiles").select("id, full_name, username").in("id",n):{data:[]},r.length>0?p.from("listings").select("id, title").in("id",r):{data:[]}]),L=new Map((f.data||[]).map(a=>[a.id,a])),W=new Map((O.data||[]).map(a=>[a.id,a])),G=s.map(a=>({...a,sender:L.get(a.sender_id),receiver:L.get(a.receiver_id),listings:a.listing_id?W.get(a.listing_id):void 0}));H(G)}catch(s){console.error("Error loading messages:",s),y({title:"Помилка",description:"Не вдалося завантажити повідомлення",variant:"destructive"})}finally{F(!1)}},k=async s=>{if(confirm("Ви впевнені, що хочете видалити це повідомлення?"))try{const{error:t}=await p.from("messages").delete().eq("id",s);if(t)throw t;y({title:"Успішно",description:"Повідомлення видалено"}),T(),D(!1)}catch{y({title:"Помилка",description:"Не вдалося видалити повідомлення",variant:"destructive"})}},V=s=>{const t=new Date,n=new Date(s),r=Math.floor((t.getTime()-n.getTime())/(1e3*60*60));if(r<1)return"Менше години тому";if(r<24)return`${r} год. тому`;const f=Math.floor(r/24);return f<7?`${f} дн. тому`:n.toLocaleDateString("uk-UA")},o=s=>(s==null?void 0:s.full_name)||(s==null?void 0:s.username)||"Анонім",q=h.filter(s=>{var r;const t=s.content.toLowerCase().includes(j.toLowerCase())||o(s.sender).toLowerCase().includes(j.toLowerCase())||o(s.receiver).toLowerCase().includes(j.toLowerCase())||(((r=s.listings)==null?void 0:r.title)||"").toLowerCase().includes(j.toLowerCase()),n=u==="all"||u==="read"&&s.is_read||u==="unread"&&!s.is_read;return t&&n}),g={total:h.length,unread:h.filter(s=>!s.is_read).length,withListing:h.filter(s=>s.listing_id).length,today:h.filter(s=>{const t=new Date().toDateString();return new Date(s.created_at).toDateString()===t}).length};return C||z?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary"})}):_?e.jsxs("div",{className:"min-h-screen bg-background",children:[e.jsx(Q,{}),e.jsxs("div",{className:"flex",children:[e.jsx("div",{className:"hidden lg:block",children:e.jsx(X,{})}),e.jsxs("main",{className:"flex-1 p-4 md:p-6 lg:p-8",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-bold bg-gradient-to-r from-primary to-primary-dark bg-clip-text text-transparent",children:"Модерація повідомлень"}),e.jsx("p",{className:"text-muted-foreground mt-1",children:"Перегляд та управління повідомленнями користувачів"})]}),e.jsxs("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsx(m,{children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(oe,{className:"w-8 h-8 text-blue-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Всього"}),e.jsx("p",{className:"text-2xl font-bold",children:g.total})]})]})})}),e.jsx(m,{children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(E,{className:"w-8 h-8 text-orange-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Непрочитані"}),e.jsx("p",{className:"text-2xl font-bold",children:g.unread})]})]})})}),e.jsx(m,{children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(me,{className:"w-8 h-8 text-green-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"З оголошеннями"}),e.jsx("p",{className:"text-2xl font-bold",children:g.withListing})]})]})})}),e.jsx(m,{children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(xe,{className:"w-8 h-8 text-purple-500"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Сьогодні"}),e.jsx("p",{className:"text-2xl font-bold",children:g.today})]})]})})})]}),e.jsx(m,{className:"mb-6",children:e.jsx(x,{className:"p-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"relative",children:[e.jsx(he,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(Y,{placeholder:"Пошук повідомлень...",value:j,onChange:s=>R(s.target.value),className:"pl-10"})]}),e.jsxs(ae,{value:u,onValueChange:U,children:[e.jsx(te,{children:e.jsx(ie,{placeholder:"Статус"})}),e.jsxs(re,{children:[e.jsx(M,{value:"all",children:"Всі повідомлення"}),e.jsx(M,{value:"unread",children:"Непрочитані"}),e.jsx(M,{value:"read",children:"Прочитані"})]})]})]})})}),e.jsx(m,{children:e.jsx(x,{className:"p-0",children:e.jsxs(Z,{children:[e.jsx(ee,{children:e.jsxs(A,{children:[e.jsx(d,{children:"Відправник"}),e.jsx(d,{children:"Отримувач"}),e.jsx(d,{children:"Оголошення"}),e.jsx(d,{children:"Повідомлення"}),e.jsx(d,{children:"Статус"}),e.jsx(d,{children:"Час"}),e.jsx(d,{className:"text-right",children:"Дії"})]})}),e.jsx(se,{children:q.map(s=>{var t;return e.jsxs(A,{className:s.is_read?"":"bg-blue-50/50 dark:bg-blue-950/20",children:[e.jsx(c,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{className:"w-8 h-8",children:e.jsx(w,{children:e.jsx(b,{className:"w-4 h-4"})})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:o(s.sender)}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.sender_id.slice(0,8),"..."]})]})]})}),e.jsx(c,{children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(v,{className:"w-8 h-8",children:e.jsx(w,{children:e.jsx(b,{className:"w-4 h-4"})})}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium",children:o(s.receiver)}),e.jsxs("div",{className:"text-xs text-muted-foreground",children:[s.receiver_id.slice(0,8),"..."]})]})]})}),e.jsx(c,{children:(t=s.listings)!=null&&t.title?e.jsx(B,{variant:"outline",className:"max-w-32 truncate",children:s.listings.title}):e.jsx("span",{className:"text-muted-foreground",children:"—"})}),e.jsx(c,{children:e.jsx("div",{className:"max-w-48 truncate text-sm",children:s.content})}),e.jsx(c,{children:e.jsx(B,{variant:s.is_read?"secondary":"default",children:s.is_read?"Прочитано":"Непрочитано"})}),e.jsx(c,{children:e.jsx("div",{className:"text-sm text-muted-foreground",children:V(s.created_at)})}),e.jsx(c,{className:"text-right",children:e.jsxs("div",{className:"flex items-center gap-2 justify-end",children:[e.jsx(N,{variant:"outline",size:"icon",onClick:()=>{P(s),D(!0)},children:e.jsx(E,{className:"w-4 h-4"})}),e.jsx(N,{variant:"destructive",size:"icon",onClick:()=>k(s.id),children:e.jsx(I,{className:"w-4 h-4"})})]})})]},s.id)})})]})})}),e.jsx(le,{open:$,onOpenChange:D,children:e.jsxs(ne,{className:"sm:max-w-lg",children:[e.jsx(de,{children:e.jsx(ce,{children:"Деталі повідомлення"})}),i&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Відправник"}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted/50 rounded-lg",children:[e.jsx(v,{className:"w-10 h-10",children:e.jsx(w,{children:e.jsx(b,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:o(i.sender)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.sender_id})]})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Отримувач"}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-muted/50 rounded-lg",children:[e.jsx(v,{className:"w-10 h-10",children:e.jsx(w,{children:e.jsx(b,{className:"w-5 h-5"})})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:o(i.receiver)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i.receiver_id})]})]})]})]}),i.listings&&e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Оголошення"}),e.jsxs("div",{className:"p-3 bg-muted/50 rounded-lg",children:[e.jsx("p",{className:"font-medium",children:i.listings.title}),e.jsx(N,{variant:"outline",size:"sm",className:"mt-2",onClick:()=>S(`/listing/${i.listing_id}`),children:"Переглянути оголошення"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium mb-2",children:"Повідомлення"}),e.jsx("div",{className:"p-4 bg-muted/30 rounded-lg",children:e.jsx("p",{className:"text-sm",children:i.content})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Статус:"})," ",i.is_read?"Прочитано":"Непрочитано"]}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium",children:"Час:"})," ",new Date(i.created_at).toLocaleString("uk-UA")]})]}),e.jsx("div",{className:"flex gap-2 pt-4 border-t",children:e.jsxs(N,{variant:"destructive",onClick:()=>k(i.id),className:"flex-1",children:[e.jsx(I,{className:"w-4 h-4 mr-2"}),"Видалити повідомлення"]})})]})]})})]})]})]}):null}export{Ee as default};
